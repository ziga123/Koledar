import customtkinter as ctk
from datetime import datetime
from datetime import date
import time

def main():
    koledar = Koledar()
    koledar.mainloop()

class Koledar(ctk.CTk):

    dnevi_tedna = ("Pon", "Tor", "Sre", "Čet", "Pet", "Sob", "Ned")
    meseci = ("Januar", "Februar", "Marec", "April", "Maj", "Junij", "Julij", "Avgust", "September", "Oktober", "November", "December")
    dnevi_mesecev = (31,28,31,30,31,30,31,31,30,31,30,31)

    def __init__(self):
        super().__init__()

        ctk.set_appearance_mode("Dark")
        ctk.set_default_color_theme("dark-blue") 

        self.title("Koledar")
        self.geometry("1200x800")

        self.columnconfigure(0,weight=1)
        self.rowconfigure(0, weight=1)
        self.rowconfigure(1,weight=7)

        self.header = Header(self)
        self.header.grid(row=0,column=0, padx=5, pady=5, sticky="ew")

        self.mreza_datumov = MrezaDatumov(self)
        self.mreza_datumov.grid(row=1,column=0, padx=5, pady=5, sticky="nsew")
        
        self.generiraj_mesec(datetime.now().month, datetime.now().year)

    def generiraj_mesec(self, mesec, leto):
        # Ni še pravilno obravnavn primer let pred 1584, ko se je nekaj dni izpustilo za prehod iz Julijanskega na Gregorijanski koledar

        prazniki = self.get_prazniki()
        dan = self.izracunaj_dan(1, mesec, leto)
        dni_v_mesecu = self.dnevi_mesecev[mesec-1]

        if mesec == 2 and (leto % 400 == 0 or (leto % 100 != 0 and leto % 4 == 0)):
            # Prestopno leto
            dni_v_mesecu = 29

        for child in self.mreza_datumov.winfo_children():
            # Resetira mrežo
            if isinstance(child, DatumFrame):
                child.destroy()

        for i in range(dan, dan + dni_v_mesecu):
            datum = DatumFrame(self.mreza_datumov, i-dan+1)
            datum.grid(row=i//7 + 1, column=i%7, sticky="nsew")
            # Nedelje obarvamo drugače
            if i % 7 == 6:
                    datum.nastavi_barvo_dneva("#D60000")
            # Praznike obarvamo drugače
            for praznik in prazniki:
                if ((praznik.datum.year == leto and praznik.datum.month == mesec and praznik.datum.day == i-dan+1) # Točno na ta dan je praznik
                   or (praznik.ponovljiv and praznik.datum.month == mesec and praznik.datum.day == i-dan+1)  # Ponovljiv praznik
                 ):
                    datum.nastavi_barvo_dneva("#7900D6")
            

    @staticmethod
    def izracunaj_dan(dan, mesec, leto):
        # Vrne kateri dan v tednu je dan/mesec/leto
        razlika = date.today() - date(leto, mesec, dan)
        return (time.localtime().tm_wday - razlika.days % 7) % 7

    @staticmethod
    def get_prazniki():
        prazniki = []
        with open("Prazniki.txt", "r", encoding="utf-8") as f:
            vrstice = f.readlines()
            for vrstica in vrstice:
                ime_praznika, dan, mesec, leto = vrstica.strip().split("/")
                ime_praznika = ime_praznika.replace("_", " ")

                if ime_praznika[-1] == "*":
                    # Znak * na koncu imena praznika pomeni, da je praznik ponovljiv
                    ponovljiv = True
                    ime_praznika = ime_praznika.replace("*", "")
                else:
                    ponovljiv = False

                prazniki.append(Praznik(ime_praznika, int(dan), int(mesec), int(leto), ponovljiv))

        return prazniki

class Header(ctk.CTkFrame):

    def __init__(self, parent):
        super().__init__(parent)

        self.app = parent

        # Vnosno polje za datum
        self.txt_datum = ctk.CTkLabel(self, text="Vnesi natančen datum v formatu DD/MM/LLLL\n in nato pritisni gumb ali enter: ")
        self.txt_datum.grid(row=0, column=0, padx=5, pady=5)
        self.vnos_datum = ctk.CTkEntry(self)
        self.vnos_datum.grid(row=0, column=1, padx=5, pady=5)
        self.vnos_gumb1 = ctk.CTkButton(
            self,
            text="Pojdi na datum",
            command=self.skok_datum
        )
        self.vnos_gumb1.grid(row=0, column=2, padx=5, pady=5)

        # Combobox za izbirco mesca
        self.txt_datum = ctk.CTkLabel(self, text="Mesec: ")
        self.txt_datum.grid(row=0, column=3, padx=5, pady=5)
        self.kombo_meseci = ctk.CTkComboBox(self, values=parent.meseci, state="readonly")
        self.kombo_meseci.grid(row=0, column=4, padx=5, pady=5)
        self.kombo_meseci.set(parent.meseci[datetime.now().month - 1])

        # Vnosno polje za izbiro leta
        self.txt_datum = ctk.CTkLabel(self, text="Leto: ")
        self.txt_datum.grid(row=0, column=5, padx=5, pady=5)
        self.vnos_leto = ctk.CTkEntry(self)
        self.vnos_leto.grid(row=0, column=6, padx=5, pady=5)
        self.vnos_leto.insert(0,str(datetime.now().year))
        self.vnos_gumb2 = ctk.CTkButton(
            self, 
            text="Potrdi", 
            command=self.skok_mesec_leto
        )
        self.vnos_gumb2.grid(row=0, column=7, padx=5, pady=5)

    def skok_datum(self):
        vnos = self.vnos_datum.get().strip()

        if vnos:
            try:
                dan, mesec, leto = map(int, vnos.split("/"))
                date(leto, mesec, dan)
            except ValueError:
                self.vnos_datum.delete(0, ctk.END)
                return
            
            self.app.generiraj_mesec(mesec, leto)
            self.vnos_datum.delete(0, ctk.END)
            self.kombo_meseci.set(self.app.meseci[mesec - 1])
            self.vnos_leto.delete(0, ctk.END)
            self.vnos_leto.insert(0, str(leto))
            
    def skok_mesec_leto(self):
        vnos = self.vnos_leto.get().strip()

        if vnos:
            try:
                self.app.generiraj_mesec(
                    self.app.meseci.index(self.kombo_meseci.get()) + 1, # mesec iz combo boxa
                    int(self.vnos_leto.get()) # leto iz vnosnega polja
                )
            except:
                self.vnos_leto.delete(0, ctk.END)


class MrezaDatumov(ctk.CTkFrame):

    def __init__(self, parent):
        super().__init__(parent)

        for i in range(0,7):
            self.columnconfigure(i,weight=1)
            if i != 0:
                # Vrstica z imenom dni se v višino ne razteza
                self.rowconfigure(i,weight=1)

        for i in range(0,7):
            dan = ctk.CTkLabel(self, text=parent.dnevi_tedna[i], font=("Arial", 30))
            dan.grid(row=0, column=i, pady=10, padx=5)

class DatumFrame(ctk.CTkFrame):

    def __init__(self, parent, dan):
        super().__init__(parent, border_width=2, border_color="black")

        self.dan = dan

        self.columnconfigure(0,weight=1)
        self.rowconfigure(0,weight=1)

        self.label = ctk.CTkLabel(self,
                     text=str(dan),
                     font=("Arial", 50, "bold"),
                     anchor="center"
                )
        self.label.grid(row=0,column=0, sticky="nsew", padx=5, pady=5)
    
    def nastavi_barvo_dneva(self, barva):
        self.label.configure(text_color=(barva, barva))

class Praznik():
    
    def __init__(self, ime, dan, mesec, leto, ponovljiv=True):
        self.ime = ime
        self.datum = date(leto, mesec, dan)
        self.ponovljiv=ponovljiv

if __name__ == "__main__":
    main()